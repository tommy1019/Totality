<html>
<head>
<meta name="viewport"
	content="initial-scale=1.0, user-scalable=no, width=device-width, height=device-height, user-scalable=0" />
<style>
.imgClass {
	display: block;
	margin-left: auto;
	margin-right: auto
}
</style>

<script src="dist/jquery-3.3.1.min.js"></script>
<script src="dist/nipplejs.min.js" charset="utf-8"></script>
</head>
<body>
<script type="text/javascript">

		var ip;

		var webSocket;

		var elements;

		var percentJoyDataSent = 50;

		var screenWidth;
		var screenHeight;
		
		var controller;
		
		var dPadStates = new Object();

		var dPadSprites = new Object();
		var dPadPressedSprites = new Object();
		
		//Load sprites
		buttonImg = new Image();
		buttonImg.src = "button.png";

		buttonPressedImg = new Image();
		buttonPressedImg.src = "buttonPressed.png"
		
		dPadSprites["UP"] = "dPadUp.png";
		dPadSprites["DOWN"] = "dPadDown.png";
		dPadSprites["LEFT"] = "dPadLeft.png";
		dPadSprites["RIGHT"] = "dPadRight.png";
		
		dPadPressedSprites["UP"] = "dPadUpPressed.png";
		dPadPressedSprites["DOWN"] = "dPadDownPressed.png";
		dPadPressedSprites["LEFT"] = "dPadLeftPressed.png";
		dPadPressedSprites["RIGHT"] = "dPadRightPressed.png";
		
		//This disables the context menu for android
		window.oncontextmenu = function(event)
		{
			event.preventDefault();
			event.stopPropagation();
			return false;
		};
		
		// Listen for orientation changes
		window.addEventListener("orientationchange", function() 
		{
			// Rebuild the controller to fit the new screen dimensions
			buildController();
		}, false);

		document.body.onload = function ()
		{
			// This is necessary to remove force touch on ios
			document.body.style.webkitTouchCallout = 'none';
			document.body.style.webkitUserSelect = 'none';

			//Get screen dimensions from the device
			screenWidth = $(window).width();
			screenHeight = $(window).height();
			
			// Get the ip of the websocket server from the web server
			// Once this is done, initialize the websocket with the new ip
			jQuery.get('webSocketIp.txt', function(data)
			{
				ip = "ws://" + data;

				webSocket = new WebSocket(ip);

				//Print to the console when the websocket connects
				webSocket.onopen = function(event)
				{
					console.log("Websocket open");
				}

				//If the websocket fails for some reason, pop up an alert window
				webSocket.onerror = function(event)
				{
					alert("There was an error connecting to the server");
				}

				//The server will send data to the client telling it what kind controller elements it needs
				//When this happens, parse the data and build the elements
				webSocket.onmessage = function(event)
				{
					console.log("Message received!");

					controller = event.data;
					buildController();
				};
			});
		}
		
		function buildController()
		{
			if(controller == null)
			{
				return;
			}
		
			screenWidth = window.innerWidth;
			screenHeight = window.innerHeight;
			
			//Clear the existing elements, if any
			while (document.body.firstChild) 
			{
				document.body.removeChild(document.body.firstChild);
			}
			
			//Load the controller elements from JSON
			elements = JSON.parse(controller).controllerElements;

			for(i = 0; i < elements.length; i++)
			{
				var controllerElement;
			
				//Create the appropriate element
				switch(elements[i].type)
				{
					case "JOYSTICK":
						console.log("Received joystick: " + elements[i].id);
						controllerElement = createJoystick(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					case "BUTTON":
						console.log("Recieved button: " + elements[i].id);
						controllerElement = createButton(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					case "TEXTINPUT":
						console.log("Received textinput: " + elements[i].id);
						controllerElement = createTextInput(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					case "TEXT":
						console.log("Received text: " + elements[i].id);
						controllerElement = createText(elements[i].id, elements[i].content, elements[i].fontSize, elements[i].x, elements[i].y);
						break;
					case "DPAD":
						console.log("Received dPad: " + elements[i].id);
						controllerElement = createDPad(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					default:
						console.log("Received unknown element: " + elements[i].id);
						break;
				}
				
				//If the controller element is not visible, hide it
				if(controllerElement != null)
				{
					if(!elements[i].visible)
					{
							controllerElement.style.display = "none";
					}
				}
			}
		}

		//Programatically creates a joystick with the given id and adds it to the given context
		function createJoystick(joystickId, xPos, yPos, width, height)
		{
			joystickDiv = document.createElement("div");
			joystickDiv.href = "#";
			joystickDiv.id = joystickId + "div";
			joystickDiv.style.background = "none";
			joystickDiv.style.border = "none";
			joystickDiv.style.outline = "none";

			// Programatically sets the width and height of the button
			joystickDiv.width  = width * screenWidth;
			joystickDiv.height = height * screenHeight;

			// Preserve the aspect ratio of the button by limiting the size to the smallest component
			if(joystickDiv.width < joystickDiv.height)
			{
				joystickDiv.height = joystickDiv.width;
			}
			else
			{
				joystickDiv.width = joystickDiv.height;
			}

			// Set position of the button
			joystickDiv.style.position = "absolute";
			joystickDiv.style.left = xPos * screenWidth - (joystickDiv.width / 2) + "px";
			joystickDiv.style.top = yPos * screenHeight - (joystickDiv.height / 2) + "px";

			document.body.appendChild(joystickDiv);

			var joystick = nipplejs.create(
			{
				zone: joystickDiv,
				mode: 'static',
				position: { x: xPos * screenWidth, y: yPos * screenHeight },
				color: 'blue',
				size: (joystickDiv.width)
			});

			joystick.id = joystickId;

			//These keep track of the movement of the joystick
			var dx;
			var dy;

			var count = 0;

			joystick.on('move', function (evt, data)
			{
				count++;

				if(count % Math.round(100 / percentJoyDataSent) == 0)
				{
					dx = Math.cos(data.angle.radian);
					dy = Math.sin(data.angle.radian);

					webSocket.send("JOYSTICK:" + joystick.id + ":state:" + dx + ":" + dy + ":" + data.distance);
				}
				if(count >= 10)
				{
					count = 0;
				}

			}).on('removed', function (evt, nipple)
			{
				nipple.off('move', 'end');

			}).on('end', function (evt, nipple)
			{
				webSocket.send("JOYSTICK:" + joystick.id + ":state:" + 0 + ":" + 0 + ":" + 0);
			});
			
			return joystickDiv;
		}

		//Programatically creates a button with the given id and adds it to the given context
		function createButton(buttonId, xPos, yPos, width, height)
		{
			var img = document.createElement("img");
			img.id = buttonId;
			img.name = buttonId + "Img";
			img.src = buttonImg.src;
            img.className = "imgClass";

			// Programatically sets the width and height of the button
			img.width  = width * screenWidth;
			img.height = height * screenHeight;

			// Preserve the aspect ratio of the button by limiting the size to the smallest component
			if(img.width < img.height)
			{
				img.height = img.width;
			}
			else
			{
				img.width = img.height;
			}

			button = document.createElement("div");
			button.href = "#";
			button.id = buttonId;
			button.style.background = "none";
			button.style.border = "none";
			button.style.outline = "none";
			button.appendChild(img);

			// Set position of the button
			button.style.position = "absolute";
			button.style.left = xPos * screenWidth - (img.width / 2) + "px";
			button.style.top = yPos * screenHeight - (img.height / 2) + "px";

			document.body.appendChild(button);

			// Adds touch and mouse listeners to each button
			// Please be careful with this code, it is VERY finnicky
			document.getElementById(buttonId).onmousedown = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).onmouseup = function(){onButtonRelease(this.id);}
			document.getElementById(buttonId).ontouchstart = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).ontouchend = function(){onButtonRelease(this.id);}
			
			return button;
		}
		
		//Programatically creates a text input field and adds it to the given context
		function createTextInput(textInputId, xPos, yPos, width, height)
		{
			var input = document.createElement("INPUT");
			input.id = textInputId;
			input.type = 'text';
			
			// Programatically sets the width and height of the textField
			input.style.width  = width * screenWidth + "px";
			input.style.height = height * screenHeight + "px";
			
			document.body.appendChild(input);
			
			input.addEventListener("input", function(){ return onTextChanged(textInputId); });
			
			// Set position of the textInput
			input.style.position = "absolute";
			input.style.left = xPos * screenWidth - (width * screenWidth / 2) + "px";
			input.style.top = yPos * screenHeight - (height * screenHeight / 2) + "px";
			input.style.padding = "5px";
			
			return input;
		}

		//Programatically creates a text box and adds it to the given context
		function createText(textID, content, fontSize, xPos, yPos)
		{
			var textDiv = document.createElement("div");
			textDiv.id = textID;
			textDiv.innerHTML = content;
			
			textDiv.style.fontSize = fontSize + "px";
			textDiv.style.textAlign = "center";
			textDiv.style.verticalAlign = "middle";
			
			// Size of the div will be determined by the size of the text
			textDiv.style.height = "auto";
			textDiv.style.width = "auto";
			textDiv.style.whiteSpace = "nowrap";
			
			document.body.appendChild(textDiv);

			// Set position of the text
			textDiv.style.position = "absolute";
			textDiv.style.left = xPos * screenWidth - (textDiv.offsetWidth / 2) + "px";
			textDiv.style.top = yPos * screenHeight - (textDiv.offsetHeight / 2) + "px";
			
			return textDiv;
		}
		
		//Programatically creates a dPad with the given id and adds it to the given context
		function createDPad(dPadId, xPos, yPos, width, height)
		{
			//Create up, down, left, and right images
			var upImg = document.createElement("img");
			upImg.id = dPadId + "UP";
			upImg.name = dPadId + "UpImg";
			upImg.src = dPadSprites["UP"];
            upImg.className = "imgClass";
			
			var downImg = document.createElement("img");
			downImg.id = dPadId + "DOWN";
			downImg.name = dPadId + "DownImg";
			downImg.src = dPadSprites["DOWN"];
            downImg.className = "imgClass";
			
			var leftImg = document.createElement("img");
			leftImg.id = dPadId + "LEFT";
			leftImg.name = dPadId + "LeftImg";
			leftImg.src = dPadSprites["LEFT"];
            leftImg.className = "imgClass";
			
			var rightImg = document.createElement("img");
			rightImg.id = dPadId + "RIGHT";
			rightImg.name = dPadId + "RightImg";
			rightImg.src = dPadSprites["RIGHT"];
            rightImg.className = "imgClass";
			
			// Calculates absolute (not relative) width and height
			var absWidth = width * screenWidth;
			var absHeight = height * screenHeight;

			// Preserve the aspect ratio of the dPad by limiting the size to the smallest component
			if(absWidth > absHeight)
			{
				absWidth = absHeight;
			}
			else
			{
				absHeight = absWidth;
			}
			
			// Programatically sets the width and height of the buttons
			upImg.width = absWidth / 4;
			upImg.height = absHeight / 2;
			
			downImg.width = absWidth / 4;
			downImg.height = absHeight / 2;
			
			leftImg.width = absWidth / 2;
			leftImg.height = absHeight / 4;
			
			rightImg.width = absWidth / 2;
			rightImg.height = absHeight / 4;

			dPad = document.createElement("div");
			dPad.href = "#";
			dPad.id = dPadId;
			dPad.style.background = "none";
			dPad.style.border = "none";
			dPad.style.outline = "none";
			dPad.appendChild(upImg);
			dPad.appendChild(downImg);
			dPad.appendChild(leftImg);
			dPad.appendChild(rightImg);

			// Set the position of each of the buttons within the div
			upImg.style.position = "absolute";
			upImg.style.left = (absWidth / 2) - (upImg.width / 2) + "px";
			upImg.style.top = 0 + "px";
			
			downImg.style.position = "absolute";
			downImg.style.left = (absWidth / 2) - (upImg.width / 2) + "px";
			downImg.style.top = (absHeight / 2) + "px";
			
			leftImg.style.position = "absolute";
			leftImg.style.left = 0 + "px";
			leftImg.style.top = (absHeight / 2) - (leftImg.height / 2) + "px";
			
			rightImg.style.position = "absolute";
			rightImg.style.left = (absWidth / 2) + "px";
			rightImg.style.top = (absHeight / 2) - (rightImg.height / 2) + "px";
			
			// Set position of the dPad on the screen
			dPad.style.position = "absolute";
			dPad.style.left = xPos * screenWidth - (absWidth / 2) + "px";
			dPad.style.top = yPos * screenHeight - (absHeight / 2) + "px";

			document.body.appendChild(dPad);

			// Adds touch and mouse listeners to each button
			// Please be careful with this code, it is VERY finnicky
			upImg.ontouchstart = function(){onDPadPress(dPad.id, "UP");}
			upImg.ontouchend = function(){onDPadRelease(dPad.id, "UP");}
			upImg.onmousedown = function(){onDPadPress(dPad.id, "UP");}
			upImg.onmouseup = function(){onDPadRelease(dPad.id, "UP");}
			
			downImg.ontouchstart = function(){onDPadPress(dPad.id, "DOWN");}
			downImg.ontouchend = function(){onDPadRelease(dPad.id, "DOWN");}
			downImg.onmousedown = function(){onDPadPress(dPad.id, "DOWN");}
			downImg.onmouseup = function(){onDPadRelease(dPad.id, "DOWN");}
			
			leftImg.ontouchstart = function(){onDPadPress(dPad.id, "LEFT");}
			leftImg.ontouchend = function(){onDPadRelease(dPad.id, "LEFT");}
			leftImg.onmousedown = function(){onDPadPress(dPad.id, "LEFT");}
			leftImg.onmouseup = function(){onDPadRelease(dPad.id, "LEFT");}
			
			rightImg.ontouchstart = function(){onDPadPress(dPad.id, "RIGHT");}
			rightImg.ontouchend = function(){onDPadRelease(dPad.id, "RIGHT");}
			rightImg.onmousedown = function(){onDPadPress(dPad.id, "RIGHT");}
			rightImg.onmouseup = function(){onDPadRelease(dPad.id, "RIGHT");}
			
			//Initialize button states to false
			dPadStates[dPadId + "UP"] = "false";
			dPadStates[dPadId + "DOWN"] = "false";
			dPadStates[dPadId + "LEFT"] = "false";
			dPadStates[dPadId + "RIGHT"] = "false";
			
			return dPad;
		}
		
		//Called when the user types in a text input field
		function onTextChanged(textInputId)
		{
			console.log("Text changed!");
			webSocket.send("TEXTINPUT:" + textInputId + ":value:" + document.getElementById(textInputId).value);
		}
		
		//Called when a button is pressed
		function onButtonPress(buttonId)
		{
			//When a button is pressed, tell the server

			webSocket.send("BUTTON:" + buttonId + ":state:" + "true");

			document.images[buttonId + "Img"].src = buttonPressedImg.src;

			return true;
		}

		//Called when the user releases a button
		function onButtonRelease(buttonId)
		{
			//When a button is released, tell the server

			webSocket.send("BUTTON:" + buttonId + ":state:" + "false");

			document.images[buttonId + "Img"].src = buttonImg.src;

			return true;
		}
		
		//Called when a dPad button is pressed
		function onDPadPress(dPadId, direction)
		{
			dPadStates[dPadId + direction] = "true";
		
			//When a button is pressed, tell the server
			webSocket.send("DPAD:" + dPadId + ":state:" + dPadStates[dPadId + "UP"] + ":" + dPadStates[dPadId + "DOWN"] + ":" + dPadStates[dPadId + "LEFT"] + ":" + dPadStates[dPadId + "RIGHT"]);
			
			document.images[dPadId + direction].src = dPadPressedSprites[direction];
			return true;
		}

		//Called when the user releases a dPad button
		function onDPadRelease(dPadId, direction)
		{
			dPadStates[dPadId + direction] = "false";
		
			//When a button is released, tell the server
			webSocket.send("DPAD:" + dPadId + ":state:" + dPadStates[dPadId + "UP"] + ":" + dPadStates[dPadId + "DOWN"] + ":" + dPadStates[dPadId + "LEFT"] + ":" + dPadStates[dPadId + "RIGHT"]);
			
			document.images[dPadId + direction].src = dPadSprites[direction];
			return true;
		}

		//This is supposed to disable pinch zoom on ios
        document.documentElement.addEventListener('gesturestart', function (event)
        {
            event.preventDefault();
        }, false);

		//This is supposed to disable scrolling on ios
        document.ontouchmove = function(event)
        {
            event.preventDefault();
        };
		
		//This disables double-tap zoom
		$(document).ready(function()
		{
			//Intercept touch events and turn them into click events
			$(document).bind('touchend', function(e) 
			{
				e.preventDefault();
				
				e.target.focus();

				$(e.target).trigger("click");
			})
		});


		
	</script>
</body>
</html>
