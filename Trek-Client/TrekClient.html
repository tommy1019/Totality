<html>
	<head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width, height=device-height" />
	    <style>
        html, body {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            margin: 0;
        }

        #left {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: rgba(0, 255, 0, 0.1);
        }

        #placeholder {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: rgba(0, 0, 255, 0.1);
        }
        </style>
		
		<div id="left"></div>
		<div id="placeholder">
        <div id="right"
		style="position: relative; top: 50%; -webkit-transform: translateY(-50%); -ms-transform: translateY(-50%); transform: translateY(-50%); left: 1px; right: 1px;"
		></div>
		</div>
		
		<script type="text/javascript">
		
		var ip = "ws://192.168.1.142:8000";
		
		var webSocket = new WebSocket(ip);

		var elements;

		var numButtons = 0;
		var numJoysticks = 0;
		
		var percentJoyDataSent = 50;
		
		buttonImg = new Image();
		buttonImg.src = "button.png";
		
		buttonPressedImg = new Image();
		buttonPressedImg.src = "buttonPressed.png"
			
		//This disables the context menu for android
		window.oncontextmenu = function(event) 
		{
			event.preventDefault();
			event.stopPropagation();
			return false;
		};
			
		//This is necessary to remove force touch on ios
		window.onload = function () 
		{
			document.body.style.webkitTouchCallout='none';
			document.body.style.webkitUserSelect='none';
		}
		
		//Print to the console when the websocket connects
		webSocket.onopen = function(event)
		{
			console.log("Websocket open");
		}
		
		//If the websocket fails for some reason, pop up an alert window
		webSocket.onerror = function(event)
		{
			alert("There was an error connecting to the server");
		}
		
		//The server will send data to the client telling it what kind of buttons and joysticks it needs
		//When this happens, parse the data and build the elements
		webSocket.onmessage = function(event) 
		{
			console.log("Message received!");

			elements = JSON.parse(event.data).controllerElements;
			
			for(i = 0; i < elements.length; i++)
			{
				switch(elements[i].type)
				{
					case "JOYSTICK":
						numJoysticks++;
						break;
					case "BUTTON":
						numButtons++;
						break;
					default:
						alert("Received unknown element: " + elements[i].id);
						break;
				}
			}
			
			for(i = 0; i < elements.length; i++)
			{
				switch(elements[i].type)
				{
					case "JOYSTICK":
						console.log("Received joystick: " + elements[i].id);
						createJoystick(document.body, elements[i].id);
						break;
					case "BUTTON":
						console.log("Recieved button: " + elements[i].id);
						createButton(document.body, elements[i].id);
						break;
					default:
						console.log("Received unknown element: " + elements[i].id);
						break;
				}
			}
		};
		
		//Programatically creates a joystick with the given id and adds it to the given context
		function createJoystick(context, joystickId)
		{
			var  verticalPosition = Math.round(100 / (numJoysticks + 1));
			
			var joystickNum = 0;
			joystickNum = parseInt(joystickId.substring(8));
			console.log("joystickNum: " + joystickNum);
			
			console.log("verticalPosition: " + verticalPosition);
			
			var joystick = nipplejs.create(
			{
				zone: document.getElementById('left'),
				mode: 'static',
				position: { left: '50%', top: joystickNum * verticalPosition + '%' },
				color: 'green',
				size: (window.screen.availWidth / 5)
			});
			
			joystick.id = joystickId;
			
			//These keep track of the movement of the joystick
			var dx;
			var dy;
			
			var count = 0;
			
			joystick.on('move', function (evt, data) 
			{
				count++;
				
				if(count % Math.round(100 / percentJoyDataSent) == 0)
				{
					dx = Math.cos(data.angle.radian);
					dy = Math.sin(data.angle.radian);
				
					webSocket.send("JOYSTICK:" + joystick.id + ":state:" + dx + ":" + dy);
				}
				if(count >= 10)
				{
					count = 0;
				}
				
			}).on('removed', function (evt, nipple) 
			{
				nipple.off('move', 'end');
				
			}).on('end', function (evt, nipple) 
			{
				webSocket.send("JOYSTICK:" + joystick.id + ":state:" + 0 + ":" + 0);
			});
		}
		
		//Programatically creates a button with the given id and adds it to the given context
		function createButton(context, buttonId)
		{			
			var img = document.createElement("img");
			id = buttonId;
			img.name = buttonId + "Img"; 
			img.src = buttonImg.src; 
			
			var screenHeight = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;
						
			img.width = screenHeight / 16 / (numButtons / 8);
			img.height = screenHeight / 16 / (numButtons / 8); 
			img.style = "display: block; margin-left: auto; margin-right: auto";

			button = document.createElement("p");
			button.href = "#";
			button.id = buttonId;
			button.style.background = "none";
			button.style.border = "none";
			button.style.outline = "none";
			button.appendChild(img);
			
			document.getElementById("right").appendChild(button);
			
			//Adds touch and mouse listeners to each button
			//Please be careful with this code, it is VERY finnicky
			document.getElementById(buttonId).onmousedown = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).onmouseup = function(){onStopButtonPress(this.id);}
			document.getElementById(buttonId).ontouchstart = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).ontouchend = function(){onStopButtonPress(this.id);}
			
		}
		
		function onButtonPress(buttonId)
		{
			//When a button is pressed, tell the server
		
			webSocket.send("BUTTON:" + buttonId + ":state:" + "true");
			
			document.images[buttonId + "Img"].src = buttonPressedImg.src;
			
			return true;
		}
		function onStopButtonPress(buttonId)
		{
			//When a button is released, tell the server
			
			webSocket.send("BUTTON:" + buttonId + ":state:" + "false");
		
			document.images[buttonId + "Img"].src = buttonImg.src;
			
			return true;
		}
        
		//This is supposed to disable pinch zoom on ios
        document.documentElement.addEventListener('gesturestart', function (event) 
        {
            event.preventDefault();      
        }, false);

		//This is supposed to disable scrolling on ios
        document.ontouchmove = function(event)
        {
            event.preventDefault();
        }
	</script>
	</head>
	
	<body>
        <script src="dist/nipplejs.min.js" charset="utf-8"></script>
        <script>

        </script>
	</body>
</html>
