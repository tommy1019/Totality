<html>
<head>
<meta name="viewport"
	content="initial-scale=1.0, user-scalable=no, width=device-width, height=device-height, user-scalable=0" />
<style>
.imgClass {
	display: block;
	margin-left: auto;
	margin-right: auto
}
</style>

<script src="dist/jquery-3.3.1.min.js"></script>
<script src="dist/nipplejs.min.js" charset="utf-8"></script>
</head>
<body>
<script type="text/javascript">

		var ip;

		var webSocket;

		var elements;

		var percentJoyDataSent = 50;

		var screenWidth;
		var screenHeight;
		
		var controller;
		
		var canvas;
		var context;
		
		var dPadStates = new Object();

		var dPadSprites = new Object();
		var dPadPressedSprites = new Object();
		
		//Load sprites
		buttonImg = loadImage("button.png");
		buttonPressedImg = loadImage("buttonPressed.png");

		dPadSprites["UP"] = loadImage("dPadUp.png");
		dPadSprites["DOWN"] = loadImage("dPadDown.png");
		dPadSprites["LEFT"] = loadImage("dPadLeft.png");
		dPadSprites["RIGHT"] = loadImage("dPadRight.png");
		
		dPadPressedSprites["UP"] = loadImage("dPadUpPressed.png");
		dPadPressedSprites["DOWN"] = loadImage("dPadDownPressed.png");
		dPadPressedSprites["LEFT"] = loadImage("dPadLeftPressed.png");
		dPadPressedSprites["RIGHT"] = loadImage("dPadRightPressed.png");
		
		//This disables the context menu for android
		window.oncontextmenu = function(event)
		{
			event.preventDefault();
			event.stopPropagation();
			return false;
		};
		
		// Listen for orientation changes
		window.addEventListener("orientationchange", function() 
		{
			// Rebuild the controller to fit the new screen dimensions
			buildController();
		}, false);

		document.body.onload = function ()
		{		
			// This is necessary to remove force touch on ios
			document.body.style.webkitTouchCallout = 'none';
			document.body.style.webkitUserSelect = 'none';

			//Get screen dimensions from the device
			screenWidth = $(window).width();
			screenHeight = $(window).height();
			
			// Get the ip of the websocket server from the web server
			// Once this is done, initialize the websocket with the new ip
			jQuery.get('webSocketIp.txt', function(data)
			{
				ip = "ws://" + data;

				webSocket = new WebSocket(ip);

				//Print to the console when the websocket connects
				webSocket.onopen = function(event)
				{
					console.log("Websocket open");
				}

				//If the websocket fails for some reason, pop up an alert window
				webSocket.onerror = function(event)
				{
					alert("There was an error connecting to the server");
				}

				//The server will send data to the client telling it what kind controller elements it needs
				//When this happens, parse the data and build the elements
				webSocket.onmessage = function(event)
				{
					console.log("Message received!");

					controller = event.data;
					buildController();
				};
			});
		}
		
		function buildController()
		{
			if(controller == null)
			{
				return;
			}
		
			screenWidth = window.innerWidth;
			screenHeight = window.innerHeight;
			
			//Clear the existing elements, if any
			while (document.body.firstChild) 
			{
				document.body.removeChild(document.body.firstChild);
			}
			
			canvas = document.createElement('canvas');
			canvas.id     = "canvas1";
			canvas.width  = screenWidth;
			canvas.height = screenHeight;
			canvas.style.position = "absolute";
			canvas.style.left = "0px";
			canvas.style.top = "0px";
			canvas.style.border   = "none";
			canvas.style.margin   = "none";
			canvas.style.padding  = "none";
			canvas.style.zIndex = -10;
			document.body.appendChild(canvas);
			context = canvas.getContext('2d');
			context.imageSmoothingQuality = "medium";
			
			//Load the controller elements from JSON
			elements = JSON.parse(controller).controllerElements;

			for(i = 0; i < elements.length; i++)
			{
				var controllerElement;
			
				//Create the appropriate element
				switch(elements[i].type)
				{
					case "JOYSTICK":
						console.log("Received joystick: " + elements[i].id);
						controllerElement = createJoystick(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					case "BUTTON":
						console.log("Recieved button: " + elements[i].id);
						controllerElement = createButton(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					case "TEXTINPUT":
						console.log("Received textinput: " + elements[i].id);
						controllerElement = createTextInput(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					case "TEXT":
						console.log("Received text: " + elements[i].id);
						controllerElement = createText(elements[i].id, elements[i].content, elements[i].fontSize, elements[i].x, elements[i].y);
						break;
					case "DPAD":
						console.log("Received dPad: " + elements[i].id);
						controllerElement = createDPad(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
						break;
					default:
						console.log("Received unknown element: " + elements[i].id);
						break;
				}
				
				//If the controller element is not visible, hide it
				if(controllerElement != null)
				{
					if(!elements[i].visible)
					{
							controllerElement.style.display = "none";
					}
				}
			}
		}

		//Programatically creates a joystick with the given id and adds it to the given context
		function createJoystick(joystickId, xPos, yPos, width, height)
		{
			joystickDiv = document.createElement("div");
			joystickDiv.href = "#";
			joystickDiv.id = joystickId + "div";
			joystickDiv.style.background = "none";
			joystickDiv.style.border = "none";
			joystickDiv.style.outline = "none";

			// Programatically sets the width and height of the button
			joystickDiv.width  = width * screenWidth;
			joystickDiv.height = height * screenHeight;

			// Preserve the aspect ratio of the button by limiting the size to the smallest component
			if(joystickDiv.width < joystickDiv.height)
			{
				joystickDiv.height = joystickDiv.width;
			}
			else
			{
				joystickDiv.width = joystickDiv.height;
			}

			// Set position of the button
			joystickDiv.style.position = "absolute";
			joystickDiv.style.left = xPos * screenWidth - (joystickDiv.width / 2) + "px";
			joystickDiv.style.top = yPos * screenHeight - (joystickDiv.height / 2) + "px";

			document.body.appendChild(joystickDiv);

			var joystick = nipplejs.create(
			{
				zone: joystickDiv,
				mode: 'static',
				position: { x: xPos * screenWidth, y: yPos * screenHeight },
				color: 'blue',
				size: (joystickDiv.width)
			});

			joystick.id = joystickId;

			//These keep track of the movement of the joystick
			var dx;
			var dy;

			var count = 0;

			joystick.on('move', function (evt, data)
			{
				count++;

				if(count % Math.round(100 / percentJoyDataSent) == 0)
				{
					dx = Math.cos(data.angle.radian);
					dy = Math.sin(data.angle.radian);

					webSocket.send("JOYSTICK:" + joystick.id + ":state:" + dx + ":" + dy + ":" + data.distance);
				}
				if(count >= 10)
				{
					count = 0;
				}

			}).on('removed', function (evt, nipple)
			{
				nipple.off('move', 'end');

			}).on('end', function (evt, nipple)
			{
				webSocket.send("JOYSTICK:" + joystick.id + ":state:" + 0 + ":" + 0 + ":" + 0);
			});
			
			return joystickDiv;
		}

		//Programatically creates a button with the given id and adds it to the given context
		function createButton(buttonId, xPos, yPos, width, height)
		{
			//Calculate absolute position and size of the button
			var imgWidth = width * screenWidth;
			var imgHeight = height * screenHeight;
			
			if(imgWidth < imgHeight)
			{
				imgHeight = imgWidth;
			}
			else
			{
				imgWidth = imgHeight;
			}
			
			var imgX = xPos * screenWidth - (imgWidth / 2);
			var imgY = yPos * screenHeight - (imgHeight / 2);
			
			//Create a div that will act as our button
			button = document.createElement("div");
			button.href = "#";
			button.id = buttonId;
			button.style.background = "none";
			button.style.border = "none";
			button.style.outline = "none";

			// Set position of the button
			button.style.position = "absolute";
			button.style.left = imgX + "px";
			button.style.top = imgY + "px";
			button.style.width = imgWidth;
			button.style.height = imgHeight;
			button.style.opacity = 0;
			
			document.body.appendChild(button);

			context.drawImage(buttonImg, imgX, imgY, imgWidth, imgHeight);
			
			// Adds touch and mouse listeners to each button
			// Please be careful with this code, it is VERY finnicky
			button.onmousedown = function(){onButtonPress(this.id);}
			button.onmouseup = function(){onButtonRelease(this.id);}
			button.ontouchstart = function(){onButtonPress(this.id);}
			button.ontouchend = function(){onButtonRelease(this.id);}
			
			return button;
		}
		
		//Programatically creates a text input field and adds it to the given context
		function createTextInput(textInputId, xPos, yPos, width, height)
		{
			var input = document.createElement("INPUT");
			input.id = textInputId;
			input.type = 'text';
			input.style.zIndex = 10;
			
			// Programatically sets the width and height of the textField
			input.style.width  = width * screenWidth + "px";
			input.style.height = height * screenHeight + "px";
			
			document.body.appendChild(input);
			
			input.addEventListener("input", function(){ return onTextChanged(textInputId); });
			
			// Set position of the textInput
			input.style.position = "absolute";
			input.style.left = xPos * screenWidth - (width * screenWidth / 2) + "px";
			input.style.top = yPos * screenHeight - (height * screenHeight / 2) + "px";
			input.style.padding = "5px";
			
			return input;
		}

		//Programatically creates a text box and adds it to the given context
		function createText(textID, content, fontSize, xPos, yPos)
		{
			var textDiv = document.createElement("div");
			textDiv.id = textID;
			textDiv.innerHTML = content;
			
			textDiv.style.fontSize = fontSize + "px";
			textDiv.style.textAlign = "center";
			textDiv.style.verticalAlign = "middle";
			
			// Size of the div will be determined by the size of the text
			textDiv.style.height = "auto";
			textDiv.style.width = "auto";
			textDiv.style.whiteSpace = "nowrap";
			
			document.body.appendChild(textDiv);

			// Set position of the text
			textDiv.style.position = "absolute";
			textDiv.style.left = xPos * screenWidth - (textDiv.offsetWidth / 2) + "px";
			textDiv.style.top = yPos * screenHeight - (textDiv.offsetHeight / 2) + "px";
			
			return textDiv;
		}
		
		//Programatically creates a dPad with the given id and adds it to the given context
		function createDPad(dPadId, xPos, yPos, width, height)
		{			
			// Calculates absolute (not relative) width and height
			var absWidth = width * screenWidth;
			var absHeight = height * screenHeight;

			// Preserve the aspect ratio of the dPad by limiting the size to the smallest component
			if(absWidth > absHeight)
			{
				absWidth = absHeight;
			}
			else
			{
				absHeight = absWidth;
			}
			
			// Calculate the absolute position of the dPad
			var absX = (xPos * screenWidth) - (absWidth / 2);
			var absY = (yPos * screenHeight) - (absHeight / 2);	
			
			//Create the container for the dPad
			var dPad = document.createElement("div");
			dPad.id = dPadId;
			dPad.href = "#";
			dPad.style.background = "none";
			dPad.style.border = "none";
			dPad.style.outline = "none";
			dPad.style.position = "absolute";
			dPad.style.left = absX + "px";
			dPad.style.top = absY + "px";
			
			//Create up, down, left, and right buttons
			var upDiv = document.createElement("div");
			upDiv.id = dPadId + "UP";
			upDiv.width = absWidth / 4;
			upDiv.height = absHeight / 2;
			upDiv.style.width = upDiv.width + "px";
			upDiv.style.height = upDiv.height + "px";
			upDiv.style.position = "absolute";
			upDiv.style.left = (absWidth / 2) - (upDiv.width / 2) + "px";
			upDiv.style.top = 0 + "px";

			var downDiv = document.createElement("div");
			downDiv.id = dPadId + "DOWN";
			downDiv.width = absWidth / 4;
			downDiv.height = absHeight / 2;
			downDiv.style.width = downDiv.width + "px";
			downDiv.style.height = downDiv.height + "px";
			downDiv.style.position = "absolute";
			downDiv.style.left = (absWidth / 2) - (downDiv.width / 2) + "px";
			downDiv.style.top = (absHeight / 2) + "px";

			var leftDiv = document.createElement("div");
			leftDiv.id = dPadId + "LEFT";
			leftDiv.width = absWidth / 2;
			leftDiv.height = absHeight / 4;
			leftDiv.style.width = leftDiv.width + "px";
			leftDiv.style.height = leftDiv.height + "px";
			leftDiv.style.position = "absolute";
			leftDiv.style.left = 0 + "px";
			leftDiv.style.top = (absHeight / 2) - (leftDiv.height / 2) + "px";
			
			var rightDiv = document.createElement("div");
			rightDiv.id = dPadId + "RIGHT";
			rightDiv.width = absWidth / 2;
			rightDiv.height = absHeight / 4;
			rightDiv.style.width = rightDiv.width + "px";
			rightDiv.style.height = rightDiv.height + "px";
			rightDiv.style.position = "absolute";
			rightDiv.style.left = (absWidth / 2) + "px";
			rightDiv.style.top = (absHeight / 2) - (rightDiv.height / 2) + "px";

			//Add the buttons to the dPad
			dPad.appendChild(upDiv);
			dPad.appendChild(downDiv);
			dPad.appendChild(leftDiv);
			dPad.appendChild(rightDiv);

			document.body.appendChild(dPad);
			
			var upPos = $("#" + dPadId + "UP").offset();
			var downPos = $("#" + dPadId + "DOWN").offset();
			var leftPos = $("#" + dPadId + "LEFT").offset();
			var rightPos = $("#" + dPadId + "RIGHT").offset();
			
			context.drawImage(dPadSprites["UP"], upPos.left, upPos.top, upDiv.width, upDiv.height);
			context.drawImage(dPadSprites["DOWN"], downPos.left, downPos.top, downDiv.width, downDiv.height);
			context.drawImage(dPadSprites["LEFT"], leftPos.left, leftPos.top, leftDiv.width, leftDiv.height);
			context.drawImage(dPadSprites["RIGHT"], rightPos.left, rightPos.top, rightDiv.width, rightDiv.height);

			// Adds touch and mouse listeners to each button
			// Please be careful with this code, it is VERY finnicky
			upDiv.ontouchstart = function(){onDPadPress(dPad.id, "UP");}
			upDiv.ontouchend = function(){onDPadRelease(dPad.id, "UP");}
			upDiv.onmousedown = function(){onDPadPress(dPad.id, "UP");}
			upDiv.onmouseup = function(){onDPadRelease(dPad.id, "UP");}
			
			downDiv.ontouchstart = function(){onDPadPress(dPad.id, "DOWN");}
			downDiv.ontouchend = function(){onDPadRelease(dPad.id, "DOWN");}
			downDiv.onmousedown = function(){onDPadPress(dPad.id, "DOWN");}
			downDiv.onmouseup = function(){onDPadRelease(dPad.id, "DOWN");}
			
			leftDiv.ontouchstart = function(){onDPadPress(dPad.id, "LEFT");}
			leftDiv.ontouchend = function(){onDPadRelease(dPad.id, "LEFT");}
			leftDiv.onmousedown = function(){onDPadPress(dPad.id, "LEFT");}
			leftDiv.onmouseup = function(){onDPadRelease(dPad.id, "LEFT");}
			
			rightDiv.ontouchstart = function(){onDPadPress(dPad.id, "RIGHT");}
			rightDiv.ontouchend = function(){onDPadRelease(dPad.id, "RIGHT");}
			rightDiv.onmousedown = function(){onDPadPress(dPad.id, "RIGHT");}
			rightDiv.onmouseup = function(){onDPadRelease(dPad.id, "RIGHT");}
			
			//Initialize button states to false
			dPadStates[dPadId + "UP"] = "false";
			dPadStates[dPadId + "DOWN"] = "false";
			dPadStates[dPadId + "LEFT"] = "false";
			dPadStates[dPadId + "RIGHT"] = "false";
			
			return dPad;
		}
		
		//Called when the user types in a text input field
		function onTextChanged(textInputId)
		{
			console.log("Text changed!");
			webSocket.send("TEXTINPUT:" + textInputId + ":value:" + document.getElementById(textInputId).value);
		}
		
		//Called when a button is pressed
		function onButtonPress(buttonId)
		{
			//When a button is pressed, tell the server
			webSocket.send("BUTTON:" + buttonId + ":state:" + "true");

			//Draw pressed button sprite
			var buttonDiv = $("#" + buttonId);
			var buttonPos = buttonDiv.offset();
			
			context.drawImage(buttonPressedImg, buttonPos.left, buttonPos.top, buttonDiv.width(), buttonDiv.height());
			
			return true;
		}

		//Called when the user releases a button
		function onButtonRelease(buttonId)
		{
			//When a button is released, tell the server
			webSocket.send("BUTTON:" + buttonId + ":state:" + "false");
			
			//Draw unpressed button sprite
			var buttonDiv = $("#" + buttonId);
			var buttonPos = buttonDiv.offset();
			
			context.drawImage(buttonImg, buttonPos.left, buttonPos.top, buttonDiv.width(), buttonDiv.height());
			
			return true;
		}
		
		//Called when a dPad button is pressed
		function onDPadPress(dPadId, direction)
		{
			dPadStates[dPadId + direction] = "true";
		
			//When a button is pressed, tell the server
			webSocket.send("DPAD:" + dPadId + ":state:" + dPadStates[dPadId + "UP"] + ":" + dPadStates[dPadId + "DOWN"] + ":" + dPadStates[dPadId + "LEFT"] + ":" + dPadStates[dPadId + "RIGHT"]);
			
			var buttonDiv = $("#" + dPadId + direction);
			var buttonPos = buttonDiv.offset();
			
			console.log("Left: " + buttonPos.left);
			console.log("Top: " + buttonPos.top);
			console.log("Width: " + buttonDiv.width());
			console.log("Height: " + buttonDiv.height());
			 
			context.drawImage(dPadPressedSprites[direction], buttonPos.left, buttonPos.top, buttonDiv.width(), buttonDiv.height());
			
			return true;
		}

		//Called when the user releases a dPad button
		function onDPadRelease(dPadId, direction)
		{
			dPadStates[dPadId + direction] = "false";
		
			//When a button is released, tell the server
			webSocket.send("DPAD:" + dPadId + ":state:" + dPadStates[dPadId + "UP"] + ":" + dPadStates[dPadId + "DOWN"] + ":" + dPadStates[dPadId + "LEFT"] + ":" + dPadStates[dPadId + "RIGHT"]);
			
			var buttonDiv = $("#" + dPadId + direction);
			var buttonPos = buttonDiv.offset();
			
			context.drawImage(dPadSprites[direction], buttonPos.left, buttonPos.top, buttonDiv.width(), buttonDiv.height());
			
			return true;
		}
		
		function loadImage(src)
		{
			var newImg = new Image();
			newImg.src = src;
			return newImg;
		}

		//This is supposed to disable pinch zoom on ios
        document.documentElement.addEventListener('gesturestart', function (event)
        {
            event.preventDefault();
        }, false);
		
		$(document).ready(function()
		{
			//Intercept touch events and turn them into click events
			//This disables double-tap zoom
			$(document).bind('touchend', function(e) 
			{
				e.preventDefault();
				
				e.target.focus();

				$(e.target).trigger("click");
			})
			
			//Disable scrolling on iOS
			$(document).bind('ontouchmove', function(e) 
			{
				e.preventDefault();
			})
			
			//Disable force touch on iOS
			$(document).bind('webkitmouseforcewillbegin', function(e) 
			{
				e.preventDefault();
			})
		});
		
	</script>
</body>
</html>
