<html>
<head>
<meta name="viewport"
	content="initial-scale=1.0, user-scalable=no, width=device-width, height=device-height" />
<style>
.imgClass {
	display: block;
	margin-left: auto;
	margin-right: auto
}
</style>

<script src="dist/jquery-3.3.1.min.js"
<script src="dist/jquery-ui-1.12.1/jquery-ui.js"></script>
<script src="dist/nipplejs.min.js" charset="utf-8"></script>
<script type="text/javascript">

		var ip;

		var webSocket;

		var elements;

		var percentJoyDataSent = 50;

		var screenWidth;
		var screenHeight;


		buttonImg = new Image();
		buttonImg.src = "button.png";

		buttonPressedImg = new Image();
		buttonPressedImg.src = "buttonPressed.png"

		//This disables the context menu for android
		window.oncontextmenu = function(event)
		{
			event.preventDefault();
			event.stopPropagation();
			return false;
		};

		window.onload = function ()
		{
			// This is necessary to remove force touch on ios
			document.body.style.webkitTouchCallout = 'none';
			document.body.style.webkitUserSelect = 'none';

			screenWidth = $(window).width();
			screenHeight = $(window).height();
			
			
			// Get the ip of the websocket server from the web server
			// Once this is done, initialize the websocket with the new ip
			jQuery.get('webSocketIp.txt', function(data)
			{
				ip = "ws://" + data;

				webSocket = new WebSocket(ip);

				//Print to the console when the websocket connects
				webSocket.onopen = function(event)
				{
					console.log("Websocket open");
				}

				//If the websocket fails for some reason, pop up an alert window
				webSocket.onerror = function(event)
				{
					alert("There was an error connecting to the server");
				}

				//The server will send data to the client telling it what kind controller elements it needs
				//When this happens, parse the data and build the elements
				webSocket.onmessage = function(event)
				{
					console.log("Message received!");

					//Clear the existing elements, if any
					while (document.body.firstChild) 
					{
						document.body.removeChild(document.body.firstChild);
					}
					
					elements = JSON.parse(event.data).controllerElements;

					for(i = 0; i < elements.length; i++)
					{
						switch(elements[i].type)
						{
							case "JOYSTICK":
								console.log("Received joystick: " + elements[i].id);
								createJoystick(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
								break;
							case "BUTTON":
								console.log("Recieved button: " + elements[i].id);
								createButton(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
								break;
							case "TEXTINPUT":
								console.log("Received textinput: " + elements[i].id);
								createTextInput(elements[i].id, elements[i].x, elements[i].y, elements[i].width, elements[i].height);
							default:
								console.log("Received unknown element: " + elements[i].id);
								break;
						}
					}
				};
			});
		}

		//Programatically creates a joystick with the given id and adds it to the given context
		function createJoystick(joystickId, xPos, yPos, width, height)
		{
			joystickDiv = document.createElement("div");
			joystickDiv.href = "#";
			joystickDiv.id = joystickId + "div";
			joystickDiv.style.background = "none";
			joystickDiv.style.border = "none";
			joystickDiv.style.outline = "none";

			// Programatically sets the width and height of the button
			joystickDiv.width  = width * screenWidth;
			joystickDiv.height = height * screenHeight;

			// Preserve the aspect ratio of the button by limiting the size to the smallest component
			if(joystickDiv.width < joystickDiv.height)
			{
				joystickDiv.height = joystickDiv.width;
			}
			else
			{
				joystickDiv.width = joystickDiv.height;
			}

			// Set position of the button
			joystickDiv.style.position = "absolute";
			joystickDiv.style.left = xPos * screenWidth + "px";
			joystickDiv.style.top = yPos * screenHeight + "px";

			document.body.appendChild(joystickDiv);

			var joystick = nipplejs.create(
			{
				zone: joystickDiv,
				mode: 'static',
				position: { x: xPos * screenWidth + joystickDiv.width / 2, y: yPos * screenHeight + joystickDiv.width / 2 },
				color: 'blue',
				size: (joystickDiv.width)
			});

			joystick.id = joystickId;

			//These keep track of the movement of the joystick
			var dx;
			var dy;

			var count = 0;

			joystick.on('move', function (evt, data)
			{
				count++;

				if(count % Math.round(100 / percentJoyDataSent) == 0)
				{
					dx = Math.cos(data.angle.radian);
					dy = Math.sin(data.angle.radian);

					webSocket.send("JOYSTICK:" + joystick.id + ":state:" + dx + ":" + dy + ":" + data.distance);
				}
				if(count >= 10)
				{
					count = 0;
				}

			}).on('removed', function (evt, nipple)
			{
				nipple.off('move', 'end');

			}).on('end', function (evt, nipple)
			{
				webSocket.send("JOYSTICK:" + joystick.id + ":state:" + 0 + ":" + 0 + ":" + 0);
			});
		}

		//Programatically creates a button with the given id and adds it to the given context
		function createButton(buttonId, xPos, yPos, width, height)
		{
			var img = document.createElement("img");
			img.id = buttonId;
			img.name = buttonId + "Img";
			img.src = buttonImg.src;
            img.className = "imgClass";

			// Programatically sets the width and height of the button
			img.width  = width * screenWidth;
			img.height = height * screenHeight;

			// Preserve the aspect ratio of the button by limiting the size to the smallest component
			if(img.width < img.height)
			{
				img.height = img.width;
			}
			else
			{
				img.width = img.height;
			}

			button = document.createElement("div");
			button.href = "#";
			button.id = buttonId;
			button.style.background = "none";
			button.style.border = "none";
			button.style.outline = "none";
			button.appendChild(img);

			// Set position of the button
			button.style.position = "absolute";
			button.style.left = xPos * screenWidth + "px";
			button.style.top = yPos * screenHeight + "px";

			document.body.appendChild(button);

			// Adds touch and mouse listeners to each button
			// Please be careful with this code, it is VERY finnicky
			document.getElementById(buttonId).onmousedown = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).onmouseup = function(){onStopButtonPress(this.id);}
			document.getElementById(buttonId).ontouchstart = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).ontouchend = function(){onStopButtonPress(this.id);}
		}
		
		//Programatically creates a text input field and adds it to the given context
		function createTextInput(textInputId, xPos, yPos, width, height)
		{
			var input = document.createElement("INPUT");
			input.id = textInputId;

			// Programatically sets the width and height of the textField
			input.width  = width * screenWidth;
			input.height = height * screenHeight;

			input.addEventListener("input", onTextChanged(textInputId));
			
			// Set position of the textInput
			input.style.position = "absolute";
			input.style.left = xPos * screenWidth + "px";
			input.style.top = yPos * screenHeight + "px";

			document.body.appendChild(input);
		}
		
		function onTextChanged(textInputId)
		{
			console.log("Text changed!");
			webSocket.send("TEXTINPUT:" + textInputId + ":value:" + input.value);
		}
		
		function onButtonPress(buttonId)
		{
			//When a button is pressed, tell the server

			webSocket.send("BUTTON:" + buttonId + ":state:" + "true");

			document.images[buttonId + "Img"].src = buttonPressedImg.src;

			return true;
		}

		function onStopButtonPress(buttonId)
		{
			//When a button is released, tell the server

			webSocket.send("BUTTON:" + buttonId + ":state:" + "false");

			document.images[buttonId + "Img"].src = buttonImg.src;

			return true;
		}

		//This is supposed to disable pinch zoom on ios
        document.documentElement.addEventListener('gesturestart', function (event)
        {
            event.preventDefault();
        }, false);

		//This is supposed to disable scrolling on ios
        document.ontouchmove = function(event)
        {
            event.preventDefault();
        };

        //This is supposed to disable double tapping on ios
        document.ontouchstart = function(event)
        {
            event.preventDefault();
        };
	</script>
</head>
</html>
