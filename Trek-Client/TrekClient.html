<html>
	<head>
        <meta name="viewport" content="initial-scale=1.0, user-scalable=no, width=device-width, height=device-height" />
	    <style>
        html, body {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 0;
            margin: 0;
        }

        #left {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: rgba(0, 255, 0, 0.1);
        }

        #right {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            width: 50%;
            background: rgba(0, 0, 255, 0.1);
        }
        </style>
		
		<script type="text/javascript">
		
		var ip = "ws://192.168.1.142:8000";
		
		var webSocket = new WebSocket(ip);

		var elements;
		
		buttonImg = new Image();
		buttonImg.src = "button.png";
		
		buttonHoverImg = new Image();
		buttonHoverImg.src = "buttonHovered.png";
		
		buttonPressedImg = new Image();
		buttonPressedImg.src = "buttonPressed.png"
			
		window.oncontextmenu = function(event) 
		{
			event.preventDefault();
			event.stopPropagation();
			return false;
		};
			
		window.onload = function () 
		{
			document.body.style.webkitTouchCallout='none';
			document.body.style.webkitUserSelect='none';
		}
		
		webSocket.onopen = function(event)
		{
			console.log("Websocket open");
		}
		
		webSocket.onerror = function(event)
		{
			alert("There was an error connecting to the server");
		}
		
		webSocket.onmessage = function(event) 
		{
			console.log("Message received!");

			elements = JSON.parse(event.data);
			
			console.log(elements.length);
			
			for(i = 0; i < elements.length; i++)
			{
				switch(elements[i].type)
				{
					case "BUTTON":
						console.log("Recieved button: " + elements[i].id);
						createButton(document.body, elements[i].id);
						break;
					case "JOYSTICK":
						console.log("Received joystick: " + elements[i].id);
						break;
					default:
						console.log("Received unknown element: " + elements[i].id);
						break;
				}
			}
		};
		
		function createButton(context, buttonId)
		{			
			var img = document.createElement("img");
			id = buttonId;
			img.name = buttonId + "Img"; 
			img.src = buttonImg.src; 
			img.width = "75%";
			img.height = "200"; 
			img.alt = "javascript button";

			button = document.createElement("p");
			button.href = "#";
			button.id = buttonId;
			button.style.background = "none";
			button.style.border = "none";
			button.style.outline = "none";
			
			button.appendChild(img);
			document.getElementById("right").appendChild(button);
			
			//Please be careful with this code, it is VERY finnicky
			document.getElementById(buttonId).onmousedown = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).onmouseup = function(){onStopButtonPress(this.id);}
			document.getElementById(buttonId).ontouchstart = function(){onButtonPress(this.id);}
			document.getElementById(buttonId).ontouchend = function(){onStopButtonPress(this.id);}
			
		}
		
		function onButtonPress(buttonId)
		{
			//When the button is pressed, send the server some data
		
			webSocket.send("BUTTON:" + buttonId + ":state:" + "true");
			
			document.images[buttonId + "Img"].src = buttonPressedImg.src;
			
			return true;
		}
		function onStopButtonPress(buttonId)
		{
			webSocket.send("BUTTON:" + buttonId + ":state:" + "false");
		
			document.images[buttonId + "Img"].src = buttonImg.src;
			return true;
		}
        
        document.documentElement.addEventListener('gesturestart', function (event) 
        {
            event.preventDefault();      
        }, false);

        document.ontouchmove = function(event)
        {
            event.preventDefault();
        }
	</script>
	</head>
	
	<body>
	    <div id="left"></div>
        <div id="right"></div>
        <script src="dist/nipplejs.min.js" charset="utf-8"></script>
        <script>
        var joystick1 = nipplejs.create(
		{
            zone: document.getElementById('left'),
            mode: 'static',
            position: { left: '50%', top: '50%' },
            color: 'green',
            size: 200
        });
		
		joystick1.id = "joystick1";
		
		joystick1.on('start end', function (evt, data) 
		{

        }).on('move', function (evt, data) 
		{
			var dx = Math.cos(data.angle.radian);
			var dy = Math.sin(data.angle.radian);
			
			webSocket.send("JOYSTICK:" + joystick1.id + ":state:" + dx + ":" + dy);
			
		}).on('removed', function (evt, nipple) 
		{
			nipple.off('move');
		});
        </script>
	</body>
</html>
